---
title: Forms+Automateでフォームの入力内容をメール送信する(添付ファイル対応)
---

# Microsoft Forms + Power Automate でフォーム入力内容をメール送信する（添付ファイル対応）

MicrosoftがOfficeアプリをサブスクリプション型に変えようとしていることもあって、
組織でOffice 365を導入しているところも多いと思います。  
Office 365に含まれるMicrosoft Formsではウェブフォームを簡単に作れますが、
回答があったことをメール通知することはできても、
回答内容をメールで送信することはできません。  
そこで、同じくOffice 365に含まれるPower Automate（旧Microsoft Flow）を使って、
入力内容が自動的にメール送信される問合せフォームを作ったときの記録です。  
アップロードされたファイルのファイル添付にも対応します。

{::options toc_levels="2,3" /}
* 目次
{:toc}

## フォームの作成・設定
### フォーム作成
Microsoft Formsでフォームを作成する。
ここでは例として以下のフォームを作る。
1. 所属・氏名: テキスト
2. カテゴリ: 選択肢
3. 問合せ内容: テキスト（長い回答）
4. 添付ファイル: ファイルのアップロード

### フォーム設定
フォームの設定で以下を確認・設定
- 「自分の所属組織内のユーザーのみが回答可能」を選択
- 「名前を記録」にチェック
- Automateを使ってメール送信するので「通知」はチェックを外す

### グループフォームに移動
ここでは業務で使うフォームを想定して、グループのフォームにする。  
フォーム一覧画面から三点リーダーをクリックして対象グループに「移動」。

### From IDの確認
移動後に「グループのフォーム」から作成・設定したフォーム画面にアクセス。  
URLの#Form-ID=<u>a0b1c2d3e4...-z9y8x7w6...</u>の下線部分を控えておく
（後のAutomateで必要）。


## Power Automateフローの作成
Power Automateで、
フォームに回答されると入力内容をメール送信するフローを作成する。  
テンプレートから修正する方法もあるが、ここでは一から作成する。

1. Power Automateの「作成」で「自動フロー」を選択
2. フロー名を適当に入力
3. フローのトリガーとして「新しい応答が送信されるとき Micrsoft Forms」を選択
4. 「作成」をクリック

## Power Automateフローの実装
### Forms入力内容の取得
トリガーだけではフォーム入力内容が取得できないのでアクションを追加する。

1. 「新しい応答が送信されるとき」の「フォームID」をクリック
2. 個人フォームは選択肢から選択できるがグループフォームは選択肢に表れないので、  
  「カスタム値を入力」を選択して先ほど控えたForm IDを入力する
3. 「Microsoft Forms」アクションの「応答の詳細を取得する」を追加
4. ステップ2同様にForm IDを入力
5. 「応答ID」は「新しい応答が送信されるとき」の「応答通知の一覧 応答ID」を指定

### タイムゾーンの変更
フォームの送信日時はタイムゾーンがUTCなのでJSTに変換する。

1. 「日時」アクションの「タイムゾーンの変換」を追加
2. 「基準時間」に「応答の詳細を取得する」の「Submission Time」を指定
3. 「変換元のタイムゾーン」に「(UTC) 協定世界時」を設定
4. 「変換先のタイムゾーン」に「(UTC+09:00) 大阪、札幌、東京」を指定
5. 必要に応じて「書式設定文字列」を設定

### 問合せ内容をHTML形式に変換
後に使うメール送信アクションでは、メール本文はHTML形式として扱われる。
そのため、入力内容をそのまま使うと、改行が無視され、また'<', '>'がタブと解釈される。  
そこで、改行を`<br>`へ、'<', '>'を'&lt;', '&gt;'へと置換した変数を用意する。

1. 「変数」アクションの「変数を初期化する」を追加
2. 「名前」をHTMLcontentsに「種類」を「文字列」に指定
3. 値に以下の「式」を入力
    ```
    replace(replace(replace(<contents>, '<', '&lt;'), '>', '&gt;'), decodeUriComponent('%0A'), '<br>')
    ```
    `<contents>`の箇所は「動的なコンテンツ」に切り替えて「応答の詳細を取得する」の「内容」を指定  
    \# 改行文字(LF)を直接入力できないので'%0A'を改行文字にデコードしている

### 添付ファイル情報を格納する変数を定義  
1. 「変数」アクションの「変数を初期化する」を追加
2. 「名前」をattachmentsに「種類」を「アレイ」に指定

### 添付ファイルの有無を確認
1. 「コントロール」アクションの「条件」を追加
2. 左側「値の選択」に「添付ファイル」を指定
3. 中央で「次の値に等しくない」を設定
4. 右側「値の選択」は空欄のまま

### 添付ファイルを取得
グループFormsからグループのSharePointサイトにアップロードされたファイルを取得する。

1. 「はいの場合」に「データ操作」アクションの「JSONの解析」を追加
2. 「はいの場合」の「JSONの解析」の後に「コントロール」アクションの「Apply to each」を追加
3. 「以前の手順から出力を選択」に「JSONの解析」の「本文」を指定
4. 「Apply to each」に「SharePoint」アクションの「ファイル コンテンツの取得」を追加
5. 「サイトのアドレス」に「カスタム値の入力」で以下の「式」を設定
    ```
    take(item().link, indexOf(item().link, '/Shared%20Documents'))
    ```
    \# ファイルURLの'/Shared%20Documents'以前を切り出している
6. 「ファイル識別子」に以下の「式」を設定
    ```
    replace(substring(item().link, indexOf(item().link, 'Shared%20Documents')), '/', '%2F')
    ```
    \# ファイルURLの'/Shared%20Documents'以降を切り出して'/'を'%2F'に変換している
7. 「Apply to each」の「ファイル コンテンツの取得」の後に「変数」アクションの「配列変数に追加」を追加
8. 「名前」をattachmentsに「値」に以下のJSONを設定
    ```JSON
    { "Name": <name>, "ContentBytes": <contents>} }
    ```
    `<name>`, `<contents>`の箇所はそれぞれ「動的なコンテンツの追加」から以下を指定
    * name: 「JSONの解析」の「name」
    * contents: 「ファイル コンテンツの取得」の「ファイル コンテンツ」

### メールの送信
1. 「条件」の後に「Office 365 Outlook」アクションの「メールの送信 (V2)」を追加
2. 詳細オプションを表示し「添付ファイル」の右上にある「アレイ全体の入力に切り替える」をクリック
3. 「添付ファイル」に「動的なコンテンツの追加」から「変数」の「attachments」を指定
4. 「宛先」「件名」「本文」「CC」「BCC」などを適宜設定
    * フォームの入力内容は「動的なコンテンツの追加」から「応答の詳細を取得する」の各項目で参照できる
    * フォーム入力者のメールアドレスは「応答の詳細を取得する」の「Responsers' Email」
    * JSTに変換したフォームの送信日時は「タイムゾーンの変換」の「返還後の時間」

### フローの保存
フローを保存すれば完了

実際にフォームを送信してみてもメールが送信されなかった場合は、
フローの実効履歴から、どのアクションで失敗したのかを確認できる。